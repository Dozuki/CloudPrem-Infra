apiVersion: grafana.integreatly.org/v1beta1
kind: GrafanaDashboard
metadata:
  name: new-category-content-primary
spec:
  resyncPeriod: "24h"
  folder: "Primary"
  plugins:
    - name: grafana-piechart-panel
      version: 1.3.9
  instanceSelector:
    matchLabels:
      dashboards: "grafana-primary"
  jsonnet: |
    local SITE_NAME = 'onprem';
    local SITE_URL = '{{ .Values.hostname }}';
    local DATASOURCE = 'MySQL';
    
    {
       "annotations": {
          "list": [
             {
                "builtIn": 1,
                "datasource": "-- Grafana --",
                "enable": true,
                "hide": true,
                "iconColor": "rgba(0, 211, 255, 1)",
                "limit": 100,
                "name": "Annotations & Alerts",
                "showIn": 0,
                "type": "dashboard"
             }
          ]
       },
       "description": "New category pages.",
       "editable": true,
       "gnetId": null,
       "graphTooltip": 0,
       "id": null,
       "iteration": 1551200441453,
       "links": [],
       "panels": [
          {
             "content": "# New Category Content\n*Review new and existing category pages.*",
             "description": "Filtered by date range and user.",
             "gridPos": {
                "h": 3,
                "w": 12,
                "x": 0,
                "y": 0
             },
             "id": 2,
             "links": [],
             "mode": "markdown",
             "title": "",
             "transparent": true,
             "type": "text"
          },
          {
             "collapsed": false,
             "gridPos": {
                "h": 1,
                "w": 24,
                "x": 0,
                "y": 3
             },
             "id": 6,
             "panels": [],
             "title": "",
             "type": "row"
          },
          {
             "content": "<h3>New Category Pages",
             "gridPos": {
                "h": 2,
                "w": 24,
                "x": 0,
                "y": 4
             },
             "id": 38,
             "links": [],
             "mode": "html",
             "title": "",
             "transparent": true,
             "type": "text"
          },
          {
             "cacheTimeout": null,
             "colorBackground": false,
             "colorValue": true,
             "colors": [
                "#20a7a3",
                "#20a7a3",
                "#20a7a3"
             ],
             "datasource": DATASOURCE,
             "description": "",
             "format": "none",
             "gauge": {
                "maxValue": 100,
                "minValue": 0,
                "show": false,
                "thresholdLabels": false,
                "thresholdMarkers": true
             },
             "gridPos": {
                "h": 2,
                "w": 6,
                "x": 0,
                "y": 6
             },
             "id": 10,
             "interval": null,
             "links": [],
             "mappingType": 1,
             "mappingTypes": [
                {
                   "name": "value to text",
                   "value": 1
                },
                {
                   "name": "range to text",
                   "value": 2
                }
             ],
             "maxDataPoints": 100,
             "nullPointMode": "connected",
             "nullText": null,
             "postfix": "",
             "postfixFontSize": "50%",
             "prefix": "",
             "prefixFontSize": "50%",
             "rangeMaps": [
                {
                   "from": "null",
                   "text": "N/A",
                   "to": "null"
                }
             ],
             "sparkline": {
                "fillColor": "rgba(31, 118, 189, 0.18)",
                "full": false,
                "lineColor": "rgb(31, 120, 193)",
                "show": false
             },
             "tableColumn": "count(distinct wikis.wikiid)",
             "targets": [
                {
                   "alias": "",
                   "format": "table",
                   "group": [],
                   "metricColumn": "none",
                   "rawQuery": true,
                   "rawSql": "SELECT \n      count(distinct wikis.wikiid)\n      \nFROM wikis\n\nwhere \n\n($USERID = 'All Users' OR wikis.author = $USERID)\n\nand wikis.namespace='TOPIC'\n\nand FROM_UNIXTIME(wikis.created_date) >= $__timeFrom()\nand FROM_UNIXTIME(wikis.created_date) <= $__timeTo()",
                   "refId": "A",
                   "select": [
                      [
                         {
                            "params": [
                               "value"
                            ],
                            "type": "column"
                         }
                      ]
                   ],
                   "timeColumn": "time",
                   "where": [
                      {
                         "name": "$__timeFilter",
                         "params": [],
                         "type": "macro"
                      }
                   ]
                }
             ],
             "thresholds": "",
             "title": "All New Categories",
             "transparent": true,
             "type": "singlestat",
             "valueFontSize": "120%",
             "valueMaps": [
                {
                   "op": "=",
                   "text": "N/A",
                   "value": "null"
                }
             ],
             "valueName": "avg"
          },
          {
             "cacheTimeout": null,
             "colorBackground": false,
             "colorValue": true,
             "colors": [
                "#20a7a3",
                "#20a7a3",
                "#20a7a3"
             ],
             "datasource": DATASOURCE,
             "description": "",
             "format": "none",
             "gauge": {
                "maxValue": 100,
                "minValue": 0,
                "show": false,
                "thresholdLabels": false,
                "thresholdMarkers": true
             },
             "gridPos": {
                "h": 2,
                "w": 6,
                "x": 6,
                "y": 6
             },
             "id": 49,
             "interval": null,
             "links": [],
             "mappingType": 1,
             "mappingTypes": [
                {
                   "name": "value to text",
                   "value": 1
                },
                {
                   "name": "range to text",
                   "value": 2
                }
             ],
             "maxDataPoints": 100,
             "nullPointMode": "connected",
             "nullText": null,
             "postfix": "",
             "postfixFontSize": "50%",
             "prefix": "",
             "prefixFontSize": "50%",
             "rangeMaps": [
                {
                   "from": "null",
                   "text": "N/A",
                   "to": "null"
                }
             ],
             "sparkline": {
                "fillColor": "rgba(31, 118, 189, 0.18)",
                "full": false,
                "lineColor": "rgb(31, 120, 193)",
                "show": false
             },
             "tableColumn": "count(distinct wikis.wikiid)",
             "targets": [
                {
                   "alias": "",
                   "format": "table",
                   "group": [],
                   "metricColumn": "none",
                   "rawQuery": true,
                   "rawSql": "SELECT \n      count(distinct wikis.wikiid)\n      \nFROM wikis\n\nwhere \n\n($USERID = 'All Users' OR wikis.author = $USERID)\n\nand wikis.namespace='TOPIC'\nand wikis.wikiid NOT IN(SELECT wikiid from wiki_areas)\n\nand FROM_UNIXTIME(wikis.created_date) >= $__timeFrom()\nand FROM_UNIXTIME(wikis.created_date) <= $__timeTo()",
                   "refId": "A",
                   "select": [
                      [
                         {
                            "params": [
                               "value"
                            ],
                            "type": "column"
                         }
                      ]
                   ],
                   "timeColumn": "time",
                   "where": [
                      {
                         "name": "$__timeFilter",
                         "params": [],
                         "type": "macro"
                      }
                   ]
                }
             ],
             "thresholds": "",
             "title": "New Orphan Categories",
             "transparent": true,
             "type": "singlestat",
             "valueFontSize": "120%",
             "valueMaps": [
                {
                   "op": "=",
                   "text": "N/A",
                   "value": "null"
                }
             ],
             "valueName": "avg"
          },
          {
             "cacheTimeout": null,
             "colorBackground": false,
             "colorValue": true,
             "colors": [
                "#20a7a3",
                "#20a7a3",
                "#20a7a3"
             ],
             "datasource": DATASOURCE,
             "description": "",
             "format": "none",
             "gauge": {
                "maxValue": 100,
                "minValue": 0,
                "show": false,
                "thresholdLabels": false,
                "thresholdMarkers": true
             },
             "gridPos": {
                "h": 2,
                "w": 6,
                "x": 12,
                "y": 6
             },
             "id": 50,
             "interval": null,
             "links": [],
             "mappingType": 1,
             "mappingTypes": [
                {
                   "name": "value to text",
                   "value": 1
                },
                {
                   "name": "range to text",
                   "value": 2
                }
             ],
             "maxDataPoints": 100,
             "nullPointMode": "connected",
             "nullText": null,
             "postfix": "",
             "postfixFontSize": "50%",
             "prefix": "",
             "prefixFontSize": "50%",
             "rangeMaps": [
                {
                   "from": "null",
                   "text": "N/A",
                   "to": "null"
                }
             ],
             "sparkline": {
                "fillColor": "rgba(31, 118, 189, 0.18)",
                "full": false,
                "lineColor": "rgb(31, 120, 193)",
                "show": false
             },
             "tableColumn": "count(distinct wikis.wikiid)",
             "targets": [
                {
                   "alias": "",
                   "format": "table",
                   "group": [],
                   "metricColumn": "none",
                   "rawQuery": true,
                   "rawSql": "SELECT \n      count(distinct wikis.wikiid)\n      \nFROM wikis\n\nwhere \n\n($USERID = 'All Users' OR wikis.author = $USERID)\n\nand wikis.namespace='TOPIC'\nand wikis.wikiid IN(SELECT wikiid from wiki_areas)\n\nand FROM_UNIXTIME(wikis.created_date) >= $__timeFrom()\nand FROM_UNIXTIME(wikis.created_date) <= $__timeTo()",
                   "refId": "A",
                   "select": [
                      [
                         {
                            "params": [
                               "value"
                            ],
                            "type": "column"
                         }
                      ]
                   ],
                   "timeColumn": "time",
                   "where": [
                      {
                         "name": "$__timeFilter",
                         "params": [],
                         "type": "macro"
                      }
                   ]
                }
             ],
             "thresholds": "",
             "title": "New Categories With Parent Categories",
             "transparent": true,
             "type": "singlestat",
             "valueFontSize": "120%",
             "valueMaps": [
                {
                   "op": "=",
                   "text": "N/A",
                   "value": "null"
                }
             ],
             "valueName": "avg"
          },
          {
             "content": "<hr>",
             "gridPos": {
                "h": 2,
                "w": 24,
                "x": 0,
                "y": 8
             },
             "id": 48,
             "links": [],
             "mode": "html",
             "title": "",
             "transparent": true,
             "type": "text"
          },
          {
             "content": "<h3>New Category Pages by Month",
             "gridPos": {
                "h": 2,
                "w": 24,
                "x": 0,
                "y": 10
             },
             "id": 46,
             "links": [],
             "mode": "html",
             "title": "",
             "transparent": true,
             "type": "text"
          },
          {
             "aliasColors": {
                "New Guides": "#6990ad"
             },
             "bars": true,
             "dashLength": 10,
             "dashes": false,
             "datasource": DATASOURCE,
             "decimals": 0,
             "description": "",
             "fill": 1,
             "gridPos": {
                "h": 8,
                "w": 24,
                "x": 0,
                "y": 12
             },
             "id": 15,
             "legend": {
                "alignAsTable": false,
                "avg": true,
                "current": false,
                "hideEmpty": true,
                "hideZero": true,
                "max": true,
                "min": true,
                "rightSide": false,
                "show": false,
                "total": true,
                "values": true
             },
             "lines": false,
             "linewidth": 5,
             "links": [],
             "nullPointMode": "null as zero",
             "percentage": false,
             "pointradius": 5,
             "points": false,
             "renderer": "flot",
             "seriesOverrides": [
                {
                   "alias": "/20/",
                   "color": "#6990ad"
                }
             ],
             "spaceLength": 10,
             "stack": false,
             "steppedLine": false,
             "targets": [
                {
                   "alias": "",
                   "format": "time_series",
                   "group": [],
                   "hide": false,
                   "metricColumn": "none",
                   "rawQuery": true,
                   "rawSql": "SELECT wikis.created_date as time, \nconcat(monthname(FROM_UNIXTIME(wikis.created_date)),\" \",year(FROM_UNIXTIME(wikis.created_date))) as metric,\n       count(wikis.wikiid) as value\nFROM wikis\n\n\n-- SELECT guideid as \"Guide ID\", percent as \"Percentage\"\n-- from guide_authors \nwhere \nwikis.namespace = 'TOPIC'\n\nand\n\n($USERID = 'All Users' OR wikis.author = $USERID)\n\nand\n\nFROM_UNIXTIME(wikis.created_date) >= $__timeFrom()\n\n\nand \n\nFROM_UNIXTIME(wikis.created_date) <= $__timeTo()\n\nGROUP BY \n\nyear(FROM_UNIXTIME(wikis.created_date)), month(FROM_UNIXTIME(wikis.created_date))\n\n;\n",
                   "refId": "A",
                   "select": [
                      [
                         {
                            "params": [
                               "value"
                            ],
                            "type": "column"
                         }
                      ]
                   ],
                   "timeColumn": "time",
                   "where": [
                      {
                         "name": "$__timeFilter",
                         "params": [],
                         "type": "macro"
                      }
                   ]
                }
             ],
             "thresholds": [],
             "timeFrom": null,
             "timeRegions": [],
             "timeShift": null,
             "title": "",
             "tooltip": {
                "shared": false,
                "sort": 0,
                "value_type": "individual"
             },
             "transparent": true,
             "type": "graph",
             "xaxis": {
                "buckets": null,
                "mode": "series",
                "name": null,
                "show": true,
                "values": [
                   "total"
                ]
             },
             "yaxes": [
                {
                   "decimals": 0,
                   "format": "locale",
                   "label": "New Guides",
                   "logBase": 1,
                   "max": null,
                   "min": "0",
                   "show": true
                },
                {
                   "format": "short",
                   "label": null,
                   "logBase": 1,
                   "max": null,
                   "min": null,
                   "show": false
                }
             ],
             "yaxis": {
                "align": false,
                "alignLevel": null
             }
          },
          {
             "content": "<hr>",
             "gridPos": {
                "h": 2,
                "w": 24,
                "x": 0,
                "y": 20
             },
             "id": 47,
             "links": [],
             "mode": "html",
             "title": "",
             "transparent": true,
             "type": "text"
          },
          {
             "collapsed": false,
             "gridPos": {
                "h": 1,
                "w": 24,
                "x": 0,
                "y": 22
             },
             "id": 45,
             "panels": [],
             "title": "",
             "type": "row"
          },
          {
             "content": "<h3>New Category Pages by Author",
             "gridPos": {
                "h": 2,
                "w": 24,
                "x": 0,
                "y": 23
             },
             "id": 43,
             "links": [],
             "mode": "html",
             "title": "",
             "transparent": true,
             "type": "text"
          },
          {
             "columns": [],
             "datasource": DATASOURCE,
             "description": "",
             "fontSize": "100%",
             "gridPos": {
                "h": 8,
                "w": 24,
                "x": 0,
                "y": 25
             },
             "id": 17,
             "links": [],
             "pageSize": 5,
             "scroll": false,
             "showHeader": true,
             "sort": {
                "col": 2,
                "desc": false
             },
             "styles": [
                {
                   "alias": "",
                   "colorMode": null,
                   "colors": [
                      "rgba(245, 54, 54, 0.9)",
                      "rgba(237, 129, 40, 0.89)",
                      "rgba(50, 172, 45, 0.97)"
                   ],
                   "dateFormat": "YYYY-MM-DD HH:mm:ss",
                   "decimals": 2,
                   "mappingType": 1,
                   "pattern": "Author",
                   "thresholds": [],
                   "type": "string",
                   "unit": "short"
                },
                {
                   "alias": "Category Creation Date",
                   "colorMode": null,
                   "colors": [
                      "rgba(245, 54, 54, 0.9)",
                      "rgba(237, 129, 40, 0.89)",
                      "rgba(50, 172, 45, 0.97)"
                   ],
                   "dateFormat": "MM/DD/YY h:mm:ss a",
                   "decimals": 2,
                   "mappingType": 1,
                   "pattern": "wiki_date",
                   "thresholds": [],
                   "type": "date",
                   "unit": "short"
                },
                {
                   "alias": "Category Name",
                   "colorMode": null,
                   "colors": [
                      "rgba(245, 54, 54, 0.9)",
                      "rgba(237, 129, 40, 0.89)",
                      "rgba(50, 172, 45, 0.97)"
                   ],
                   "dateFormat": "YYYY-MM-DD HH:mm:ss",
                   "decimals": 2,
                   "link": true,
                   "linkTargetBlank": true,
                   "linkTooltip": "https://" + SITE_URL + "/c/${__cell:raw}",
                   "linkUrl": "https://" + SITE_URL + "/c/${__cell:raw}",
                   "mappingType": 1,
                   "pattern": "title",
                   "preserveFormat": false,
                   "sanitize": true,
                   "thresholds": [],
                   "type": "string",
                   "unit": "short"
                },
                {
                   "alias": "Category ID",
                   "colorMode": null,
                   "colors": [
                      "rgba(245, 54, 54, 0.9)",
                      "rgba(237, 129, 40, 0.89)",
                      "rgba(50, 172, 45, 0.97)"
                   ],
                   "dateFormat": "YYYY-MM-DD HH:mm:ss",
                   "decimals": 0,
                   "mappingType": 1,
                   "pattern": "wikiid",
                   "thresholds": [],
                   "type": "number",
                   "unit": "none"
                },
                {
                   "alias": "",
                   "colorMode": null,
                   "colors": [
                      "rgba(245, 54, 54, 0.9)",
                      "rgba(237, 129, 40, 0.89)",
                      "rgba(50, 172, 45, 0.97)"
                   ],
                   "decimals": 0,
                   "pattern": "/.*/",
                   "thresholds": [],
                   "type": "number",
                   "unit": "none"
                }
             ],
             "targets": [
                {
                   "alias": "",
                   "format": "table",
                   "group": [],
                   "metricColumn": "none",
                   "rawQuery": true,
                   "rawSql": "SELECT \n      wikis.title, wikis.wikiid,  wa.area as \"Parent Category\", global_users.username as \"Author\", CONVERT_TZ(FROM_UNIXTIME(wikis.created_date), @@session.time_zone, '+00:00') as wiki_date,\n\n      CASE\n      when wikis.text!=\"\"\n      then \"Active\"\n      Else \"Deleted\"\n      end as \"Status\"\n      \nFROM wikis\nleft join global_users on global_users.userid=wikis.author\nleft join wiki_areas wa on wikis.wikiid=wa.wikiid\n\n\nwhere \n\n($USERID = 'All Users' OR wikis.author = $USERID)\n\nand wikis.namespace='TOPIC'\n\nand FROM_UNIXTIME(wikis.created_date) >= $__timeFrom()\nand FROM_UNIXTIME(wikis.created_date) <= $__timeTo()",
                   "refId": "A",
                   "select": [
                      [
                         {
                            "params": [
                               "value"
                            ],
                            "type": "column"
                         }
                      ]
                   ],
                   "timeColumn": "time",
                   "where": [
                      {
                         "name": "$__timeFilter",
                         "params": [],
                         "type": "macro"
                      }
                   ]
                }
             ],
             "title": "",
             "transform": "table",
             "transparent": true,
             "type": "table"
          }
       ],
       "refresh": false,
       "schemaVersion": 16,
       "style": "dark",
       "tags": [
          "Content",
          "New Wiki Content"
       ],
       "templating": {
          "list": [
             {
                "current": {
                   "text": "Dozuki",
                   "value": "Dozuki"
                },
                "hide": 2,
                "label": "Guide Database",
                "name": "GUIDE_DB",
                "options": [],
                "query": "mysql",
                "refresh": 1,
                "regex": "",
                "skipUrlSync": false,
                "type": "datasource"
             },
             {
                "allValue": null,
                "current": {
                   "text": SITE_NAME,
                   "value": SITE_NAME
                },
                "hide": 2,
                "includeAll": false,
                "label": "Site Name",
                "multi": false,
                "name": "SITE_NAME",
                "options": [
                   {
                      "selected": true,
                      "text": SITE_NAME,
                      "value": SITE_NAME
                   }
                ],
                "query": SITE_NAME,
                "skipUrlSync": false,
                "type": "custom"
             },
             {
                "allValue": "'All Users'",
                "current": {
                   "text": "All",
                   "value": "$__all"
                },
                "datasource": DATASOURCE,
                "definition": "",
                "hide": 0,
                "includeAll": true,
                "label": "Author",
                "multi": false,
                "name": "USERID",
                "options": [],
                "query": "select  CONCAT(global_users.username, \" â€” \", \"User ID:\", global_users.userid) AS __text, global_users.userid AS __value from global_users",
                "refresh": 1,
                "regex": "",
                "skipUrlSync": false,
                "sort": 0,
                "tagValuesQuery": "",
                "tags": [],
                "tagsQuery": "",
                "type": "query",
                "useTags": false
             }
          ]
       },
       "time": {
          "from": "now-90d",
          "to": "now"
       },
       "timepicker": {
          "refresh_intervals": [
             "5s",
             "10s",
             "30s",
             "1m",
             "5m",
             "15m",
             "30m",
             "1h",
             "2h",
             "1d"
          ],
          "time_options": [
             "5m",
             "15m",
             "1h",
             "6h",
             "12h",
             "24h",
             "2d",
             "7d",
             "30d"
          ]
       },
       "timezone": "browser",
       "title": "New Category Content",
       "uid": null,
       "version": 10
    }
