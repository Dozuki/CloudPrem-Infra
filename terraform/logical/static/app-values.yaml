# Values.yaml for Helm Chart using nested structure for multiple deployments

# hostname: the fully-qualified domain name for this Dozuki deployment. This is the
#   DNS name that the users will use to connect
hostname: "${hostname}"

# dns_validation: Set to true if you control the DNS for the FQDN above, or false if not.
dns_validation: ${dns_validation}

# customer: This is the name of the deployment. This value will be prefixed to all kubernetes
#   resources created.
customer: "${customer}"
environment: "${environment}"

# Deployment SSL configuration (manual tls)
tls:
  enabled: false
  # The base64-encoded string of the SSL certificate that the app will use. Must
  #   be the full certificate chain. The CN must match the value for the `hostname` stanza above.
  cert: ""
  # The base64-encoded private key that matches the certificate above.
  key: ""

# If the customer is using a private CA for SSL, specify the configmap housing the ca crt here and set enabled: true
customCA:
  enabled: false
  # Name of existing ConfigMap containing CA certificates
  configMapName: "customer-ca-cert"

aws:
  region: "${aws_region}"
  accountId: "${aws_acct_id}"
  enabled: true

# Deployment DB configuration
#   This stanza contains information pertaining to the MySQL database that this deployment
#   will use.
db:
  # host: the IP, or FQDN, of the MySQL Instance host.
  host: "${db_host}"
  # user: the MySQL username
  user: "${db_user}"
  # password: the MySQL password
  password: "${db_password}"
  # use_pod: If you do not have a separate DB host, you can run MySQL in a pod. This should
  #   only be used for testing purposes as it is ephemeral and may lead to data loss.
  #   This value should generally be left as 'false'
  use_pod: false
  rdsCaCert: |
    ${rds_ca_cert}

# SMTP configuration
smtp:
  # enabled: true/false; do you want to send emails from this deployment?
  enabled: ${smtp_enabled}
  # host: The SMTP hostname
  host: "${smtp_host}"
  starttls: true
  from: "${smtp_from_address}"
  auth:
    # auth: true/false: do you want to use SMTP auth?
    enabled: ${smtp_auth_enabled}
    method: "PLAIN"
    # username: if using SMTP auth, what is the username
    username: "${smtp_username}"
    # password: if using SMTP auth, what is the password?
    password: "${smtp_password}"

sentry:
  dsn: "${sentry_dsn}"
  customerName: "${customer}"
  versionLabel: "1.0.0"

frontegg:
  clientId: "${frontegg_client_id}"
  apiToken: "${frontegg_api_token}"

surveyjs:
  licenseKey: "${surveyjs_license_key}"
googleTranslate:
  token: "${google_translate_token}"

cert_manager:
  enabled: true

hostAliases:
  - ip: "168.0.0.0"
    hostnames:
      - "ping.dozuki.com"
      - "dozuki.com"
      - "www.dozuki.com"

images:
  app:
    repository: "${image_repository}"
    path: "app"
    tag: "${image_tag}"
    pullPolicy: "IfNotPresent"
  webnextjs:
    path: "${nextjs_repository}"
    tag: "${nextjs_tag}"
    pullPolicy: "IfNotPresent"


featureRequests:
  - name: "courses"
    enabled: true
    creationPhase: "10"
    flagName: "feature-courses"
    enabledValue: "true"
    disabledValue: "false"
  - name: "guides"
    enabled: false
    creationPhase: "20"
    flagName: "feature-guides"
    enabledValue: "true"
    disabledValue: "false"
  - name: "notifications"
    enabled: true
    creationPhase: "15"
    flagName: "feature-notifications"
    enabledValue: "enabled"
    disabledValue: "disabled"

ingress:
  name: "app"
  certIssuer: "cert-issuer"
  sslRedirect: "true"
  forceSslRedirect: "true"
  configurationSnippet: "proxy_set_header X-Forwarded-Proto $scheme;"
  proxyBodySize: "0"
  ingressClassName: "nginx"
  hosts:
    - hostname: "${hostname}"
      tlsSecretName: "tls-secret"
      paths:
        - path: "/_next"
          pathType: "Prefix"
          service:
            name: "nextjs"
            port: 3210
        - path: "/Courses"
          pathType: "Prefix"
          service:
            name: "nextjs"
            port: 3210
        - path: "/Skills"
          pathType: "Prefix"
          service:
            name: "nextjs"
            port: 3210
        - path: "/external-training-modules"
          pathType: "Prefix"
          service:
            name: "nextjs"
            port: 3210
        - path: "/User/Signoffs"
          pathType: "Prefix"
          service:
            name: "nextjs"
            port: 3210
        - path: "/Quizzes"
          pathType: "Prefix"
          service:
            name: "nextjs"
            port: 3210
        - path: "/Apps"
          pathType: "Prefix"
          service:
            name: "nextjs"
            port: 3210
        - path: "/v2"
          pathType: "Prefix"
          service:
            name: "nextjs"
            port: 3210
        - path: "/Guide/intro/periodic-review"
          pathType: "Prefix"
          service:
            name: "nextjs"
            port: 3210
        - path: "/JIB"
          pathType: "Prefix"
          service:
            name: "nextjs"
            port: 3210
        - path: "/bff-api"
          pathType: "Prefix"
          service:
            name: "nextjs"
            port: 3210
        - path: "/"
          pathType: "Prefix"
          service:
            name: "app"
            port: 80
# Values.yaml for Services Template

service:
  - name: app
    creationPhase: "-1"
    appLabel: "app"
    ports:
      - name: "app-port-80"
        protocol: "TCP"
        port: 80
        targetPort: 80
  - name: searchd
    creationPhase: "-1"
    appLabel: "searchd"
    ports:
      - name: "searchd-port-3312"
        protocol: "TCP"
        port: 3312
        targetPort: 3312
  - name: pixelping
    creationPhase: "-1"
    appLabel: "pixel-ping"
    ports:
      - name: "pixel-ping-port-9187"
        protocol: "TCP"
        port: 9187
        targetPort: 9187
  - name: blessyou
    creationPhase: "-1"
    appLabel: "blessyou"
    ports:
      - name: "blessyou-port-7355"
        protocol: "TCP"
        port: 7355
        targetPort: 7355
  - name: beanstalkd
    creationPhase: "-1"
    appLabel: "beanstalkd"
    ports:
      - name: "beanstalkd-port-11300"
        protocol: "TCP"
        port: 11300
        targetPort: 11300
  - name: syslog
    creationPhase: "-1"
    appLabel: "syslog"
    ports:
      - name: "syslog-port-514"
        protocol: "UDP"
        port: 514
        targetPort: 514
  - name: consul
    creationPhase: "-1"
    appLabel: "consul"
    ports:
      - name: "consul-port-8500"
        protocol: "TCP"
        port: 8500
        targetPort: 8500
  - name: nextjs
    creationPhase: "-1"
    appLabel: "nextjs"
    ports:
      - name: "nextjs-port-3210"
        protocol: "TCP"
        port: 3210
        targetPort: 3210

# Values.yaml for Secrets Template
secrets:
  - name: grafana-common-config
    enabled: ${bi_enabled} # set true if BI is enabled
    stringData:
      GRAFANA_SUBPATH: "/dashboards"
      GF_SERVER_SERVE_FROM_SUBPATH: "true"
      GF_USERS_DEFAULT_THEME: "light"
      GF_DATABASE_TYPE: "mysql"
      GF_DATABASE_HOST: "${grafana_settings_hostname}"
      GF_DATABASE_USER: "${grafana_settings_username}"
      GF_DATABASE_PASSWORD: "${grafana_settings_password}"
      GF_ANALYTICS_REPORTING_ENABLED: "false"
      GF_ANALYTICS_CHECK_FOR_UPDATES: "false"
      GF_METRICS_ENABLED: "false"
      GF_SECURITY_ADMIN_PASSWORD: "${grafana_admin_password}"
      GF_SECURITY_ADMIN_USER: "${grafana_admin_username}"
      GF_SECURITY_COOKIE_SECURE: "true"
      GF_SECURITY_DATA_SOURCE_PROXY_WHITELIST: "1.1.1.1:1"
      GF_SECURITY_COOKIE_SAMESITE: "strict"
      GF_SECURITY_X_XSS_PROTECTION: "true"
      GF_SMTP_ENABLED: "${grafana_smtp_enabled}"
      GF_SMTP_HOST: "${grafana_smtp_host}"
      GF_SMTP_USER: "${grafana_smtp_user}"
      GF_SMTP_PASSWORD: "${grafana_smtp_password}"
      GF_SMTP_FROM_ADDRESS: "${grafana_smtp_from_address}"
      GF_SMTP_FROM_NAME: "Dozuki Grafana Dashboard"
      GF_SMTP_STARTTLS_POLICY: "${grafana_smtp_starttls}"
  - name: ops-basic-auth
    enabled: true
    stringData:
      auth: "${ops_basic_auth}"

hpas:
  - name: app-hpa
    behavior:
      scaleUp:
        stabilizationWindowSeconds: 0
        policies:
          - type: Percent
            value: 100
            periodSeconds: 300
          - type: Pods
            value: 2
            periodSeconds: 300
    scaleTargetRef:
      name: app-deployment
    minReplicas: 4
    maxReplicas: 30
    metrics:
      - type: Resource
        resource:
          name: memory
          target:
            type: Utilization
            averageUtilization: 80
      - type: Resource
        resource:
          name: cpu
          target:
            type: Utilization
            averageUtilization: 80

  - name: queueworkerd-hpa
    behavior:
      scaleUp:
        stabilizationWindowSeconds: 0
        policies:
          - type: Percent
            value: 100
            periodSeconds: 120
          - type: Pods
            value: 2
            periodSeconds: 120
    scaleTargetRef:
      name: queueworkerd-deployment
    minReplicas: 2
    maxReplicas: 50
    metrics:
      - type: Resource
        resource:
          name: memory
          target:
            type: Utilization
            averageUtilization: 80
      - type: Resource
        resource:
          name: cpu
          target:
            type: Utilization
            averageUtilization: 80

  - name: nextjs-hpa
    scaleTargetRef:
      name: web-nextjs-deployment
    minReplicas: 2
    maxReplicas: 20
    metrics:
      - type: Resource
        resource:
          name: memory
          target:
            type: Utilization
            averageUtilization: 80
      - type: Resource
        resource:
          name: cpu
          target:
            type: Utilization
            averageUtilization: 80

webhooks:
  enabled: ${webhooks_enabled}

connectivity:
  frontegg:
    images:
      username: "${frontegg_docker_username}"
      password: "${frontegg_docker_password}"

  api-gateway:
    frontegg:
      authenticationPublicKey: "${frontegg_auth_pubkey}"

  webhook-service:
    messageBroker:
      brokerList: "${msk_bootstrap_brokers}"
    mysql:
      host: "${db_host}"
      username: "${db_user}"
      password: "${db_password}"
    mongo:
      connectionString: "mongodb://dozuki-mongodb/webhooks"

  integrations-service:
    messageBroker:
      brokerList: "${msk_bootstrap_brokers}"
    mongo:
      connectionString: "mongodb://dozuki-mongodb/integrations"
    frontegg:
      slack:
        encryptionKey: "dummyval"

  event-service:
    database:
      host: "${db_host}"
      username: "${db_user}"
      password: "${db_password}"
    messageBroker:
      brokerList: "${msk_bootstrap_brokers}"
    redis:
      host: "dozuki-redis-master"
      tls: "false"
    frontegg:
      clientId: "${frontegg_client_id}"
      apiKey: "${frontegg_api_token}"
      sync:
        enabled: "false"
      authenticationUrl: "https://api.frontegg.com/auth/vendor"

  connectors-worker:
    messageBroker:
      brokerList: "${msk_bootstrap_brokers}"
    redis:
      host: "dozuki-redis-master"
      tls: "false"
    frontegg:
      channels: "slack"
      emails:
        provider: "sendgrid"
        sendgrid:
          apiKey: "dummyval"

# values.yaml

# For S3 or S3-compatible services. If endpoint is empty, S3 assumed.
objectStorage:
  kmsKey: "${s3_kms_key}"
  endpoint: ""
  imagesBucket: "${s3_images_bucket}"
  pdfsBucket: "${s3_pdfs_bucket}"
  documentsBucket: "${s3_documents_bucket}"
  objectsBucket: "${s3_objects_bucket}"
  credentials:
    accessKey: ""
    secretKey: ""

coredns:
  enabled: false
  customDomain: "onprem.dozuki"
  # Ingress controller service for main app traffic
  ingressService: "ingress-nginx-controller"

deployments:
  app:
    name: app
    replicaCount: 4
    command:
      - "bash"
      - "/bootstrap/entrypoints/app.sh"
    env:
      - name: "SSL_PROTOCOL"
        value: "all -SSLv3 -TLSv1 -TLSv1.1"
      - name: "SSL_CIPHER_SUITE"
        value: "ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384"
      - name: "HTTPS"
        value: "on"
    volumeMounts:
      - name: "dozuki-config"
        mountPath: "/etc/dozuki"
      - name: "le-tls-cert"
        mountPath: "/var/www/key"
        readOnly: true
    resources:
      requests:
        cpu: "200m"
        memory: "256Mi"
    ports:
      - containerPort: 80
      - containerPort: 443
    volumes:
      - name: "dozuki-config"
        configMap: "dozuki-resources-configmap"
      - name: "le-tls-cert"
        secret: "tls-secret"
    restartPolicy: "Always"
    initContainers:
      - name: db-startup-check
        command:
          - bash
          - "/bootstrap/entrypoints/db_startup_check.sh"
        volumeMounts:
          - name: dozuki-config
            mountPath: "/etc/dozuki"
        resources:
          requests:
            cpu: 200m
            memory: 256Mi
      - name: db-initialize
        command:
          - bash
          - "-e"
          - "/bootstrap/db_initialize.sh"
        volumeMounts:
          - name: dozuki-config
            mountPath: "/etc/dozuki"
        resources:
          requests:
            cpu: 200m
            memory: 256Mi
      - name: db-rds-snapshot
        command:
          - bash
          - "/bootstrap/entrypoints/db_rds_snapshot.sh"
        env:
          - name: APPLICATION_RELEASE_NUMBER
            value: ''
        volumeMounts:
          - name: dozuki-config
            mountPath: "/etc/dozuki"
        resources:
          requests:
            cpu: 200m
            memory: 256Mi
      - name: db-migrations
        command:
          - bash
          - "/bootstrap/entrypoints/db_migrations.sh"
        env:
          - name: APPLICATION_RELEASE_NUMBER
            value: ''
        volumeMounts:
          - name: dozuki-config
            mountPath: "/etc/dozuki"
        resources:
          requests:
            cpu: 200m
            memory: 256Mi
  beanstalkd:
    name: beanstalkd
    replicaCount: 1
    command:
      - "/usr/local/bin/beanstalkd"
      - "-p"
      - "11300"
    volumeMounts:
      - name: "dozuki-config"
        mountPath: "/etc/dozuki"
    resources:
      requests:
        cpu: "50m"
        memory: "128Mi"
    ports:
      - containerPort: 11300
    readinessProbe:
      tcpSocket:
        port: 11300
      initialDelaySeconds: 5
      periodSeconds: 10
    volumes:
      - name: "dozuki-config"
        configMap: "dozuki-resources-configmap"
    restartPolicy: "Always"
  blessyou:
    name: blessyou
    replicaCount: 1
    command:
      - "/opt/blessyou/bin/blessyou"
      - "--port=7355"
      - "--host=0.0.0.0"
    volumeMounts:
      - name: "dozuki-config"
        mountPath: "/etc/dozuki"
    resources:
      requests:
        cpu: "5m"
        memory: "64Mi"
    ports:
      - containerPort: 7355
    volumes:
      - name: "dozuki-config"
        configMap: "dozuki-resources-configmap"
    restartPolicy: "Always"

  consul:
    name: consul
    replicaCount: 1
    image:
      path: "consul"
      tag: "${consul_tag}"
    command:
      - "/usr/local/bin/docker-entrypoint.sh"
      - "agent"
      - "-dev"
      - "-client"
      - "0.0.0.0"
    volumeMounts:
      - name: "dozuki-config"
        mountPath: "/etc/dozuki"
    resources:
      requests:
        cpu: "15m"
        memory: "16Mi"
    ports:
      - containerPort: 8500
    volumes:
      - name: "dozuki-config"
        configMap: "dozuki-resources-configmap"
    restartPolicy: "Always"

  crond:
    name: crond
    replicaCount: 1
    command:
      - "bash"
      - "/bootstrap/entrypoints/crond.sh"
    volumeMounts:
      - name: "dozuki-config"
        mountPath: "/etc/dozuki"
    resources:
      requests:
        cpu: "10m"
        memory: "32Mi"
    livenessProbe:
      command:
        - /bin/sh
        - -c
        - "nc -z beanstalkd 11300 || exit 1"
      initialDelaySeconds: 15
      periodSeconds: 20
      failureThreshold: 3
    volumes:
      - name: "dozuki-config"
        configMap: "dozuki-resources-configmap"
    restartPolicy: "Always"
    initContainers:
      - name: wait-for-beanstalkd
        image: busybox:1.28
        command:
          - /bin/sh
          - -c
          - "until nc -z beanstalkd 11300; do echo 'Waiting for beanstalkd'; sleep 2; done"

  pixelPing:
    name: pixel-ping
    replicaCount: 2
    command:
      - "/bin/node"
      - "/opt/pixel-ping/bin/pixel-ping"
      - "/opt/pixel-ping/config.json"
    volumeMounts:
      - name: "dozuki-config"
        mountPath: "/etc/dozuki"
    resources:
      requests:
        cpu: "1m"
        memory: "32Mi"
    ports:
      - containerPort: 9187
    volumes:
      - name: "dozuki-config"
        configMap: "dozuki-resources-configmap"
    restartPolicy: "Always"

  queueworkerd:
    name: queueworker
    creationPhase: "10"
    replicaCount: 2
    command:
      - "bash"
      - "/bootstrap/entrypoints/queueworkerd.sh"
    volumeMounts:
      - name: "dozuki-config"
        mountPath: "/etc/dozuki"
      - name: "sidecar-script"
        mountPath: "/sidecar"
    resources:
      requests:
        cpu: "200m"
        memory: "512Mi"
    livenessProbe:
      command:
        - /bin/sh
        - -c
        - "nc -z beanstalkd 11300 || exit 1"
      initialDelaySeconds: 15
      periodSeconds: 20
      failureThreshold: 3
    watcher:
      resources:
        requests:
          cpu: "50m"
          memory: "32Mi"
    volumes:
      - name: "dozuki-config"
        configMap: "dozuki-resources-configmap"
      - name: "sidecar-script"
        configMap: "beanstalkd-watcher-script"
    restartPolicy: "Always"
    initContainers:
      - name: wait-for-beanstalkd
        image: busybox:1.28
        command:
          - /bin/sh
          - -c
          - "until nc -z beanstalkd 11300; do echo 'Waiting for beanstalkd'; sleep 2; done"

  searchd:
    name: searchd
    replicaCount: 2
    command:
      - "bash"
      - "/bootstrap/entrypoints/searchd.sh"
    volumeMounts:
      - name: "dozuki-config"
        mountPath: "/etc/dozuki"
    resources:
      requests:
        cpu: "100m"
        memory: "512Mi"
    ports:
      - containerPort: 3312
    volumes:
      - name: "dozuki-config"
        configMap: "dozuki-resources-configmap"
    restartPolicy: "Always"
    affinity:
      podAntiAffinity:
        preferredDuringSchedulingIgnoredDuringExecution:
          - weight: 100
            podAffinityTerm:
              labelSelector:
                matchExpressions:
                  - key: app
                    operator: In
                    values:
                      - searchd
                topologyKey: "kubernetes.io/hostname"

  syslog:
    name: syslog
    replicaCount: 1
    command:
      - "/usr/sbin/syslog-ng"
      - "-F"
    volumeMounts:
      - name: "dozuki-config"
        mountPath: "/etc/dozuki"
    resources:
      requests:
        cpu: "1m"
        memory: "8Mi"
    ports:
      - containerPort: 514
    volumes:
      - name: "dozuki-config"
        configMap: "dozuki-resources-configmap"
    restartPolicy: "Always"

  webNextjs:
    name: nextjs
    replicaCount: 2
    imagePullPolicy: "IfNotPresent"
    command:
      - "node"
      - "server.js"
    env:
      SERVER_SIDE_MONOLITH_API_URL: "http://app"
    resources:
      requests:
        cpu: "200m"
        memory: "256Mi"
    ports:
      - containerPort: 3210
    affinity:
      podAntiAffinity:
        preferredDuringSchedulingIgnoredDuringExecution:
          - weight: 100
            podAffinityTerm:
              labelSelector:
                matchExpressions:
                  - key: app
                    operator: In
                    values:
                      - nextjs
                topologyKey: "kubernetes.io/hostname"
    restartPolicy: "Always"

aws-node-termination-handler:
  enabled: true
  enableSqsTerminationDraining: true
  queueURL: '${nth_sqs_queue_id}'
  webhookURL: '${slack_webhook_url}'
  enablePrometheusServer: true
  emitKubernetesEvents: true
  completeLifecycleActionDelaySeconds: 30
  serviceAccount:
    name: aws-node-termination-handler
    annotations:
      "eks.amazonaws.com/role-arn": "${nth_role_arn}"

grafana:
  enabled: ${bi_enabled}
  path: "dashboards"
  security:
    admin_user: "${grafana_admin_username}"
    admin_password: "${grafana_admin_password}"
  datasource:
    host: "${grafana_datasource_hostname}"
    user: "username"
    password: "${grafana_datasource_password}"

kube-prometheus-stack:
  defaultRules:
    rule:
      kubeControllerManager: false
      kubeSchedulerAlerting: false
      kubeSchedulerRecording: false
      windows: false
  alertmanager:
    ingress:
      enabled: true
      ingressClassName: nginx
      annotations:
        cert-manager.io/cluster-issuer: "cert-issuer"
        nginx.ingress.kubernetes.io/ssl-redirect: "true"
        nginx.ingress.kubernetes.io/force-ssl-redirect: "true"
        nginx.ingress.kubernetes.io/auth-type: basic
        nginx.ingress.kubernetes.io/auth-secret: ops-basic-auth
        nginx.ingress.kubernetes.io/auth-realm: 'Authentication Required'
      hosts:
        - 'alertmanager.${hostname}'
      paths:
        - /
      pathType: ImplementationSpecific
      tls:
        - secretName: alertmanager-general-tls
          hosts:
            - 'alertmanager.${hostname}'
    alertmanagerSpec:
      storage:
        volumeClaimTemplate:
          spec:
            accessModes: [ "ReadWriteOnce" ]
            resources:
              requests:
                storage: 50Gi
      alertmanagerConfigNamespaceSelector:
        matchLabels:
          "kubernetes.io/metadata.name": dozuki
  grafana:
    defaultDashboardsTimezone: America/Los_Angeles
    adminPassword: '${infra_auth_password}'
    ingress:
      enabled: true
      ingressClassName: nginx
      annotations:
        cert-manager.io/cluster-issuer: "cert-issuer"
        nginx.ingress.kubernetes.io/ssl-redirect: "true"
        nginx.ingress.kubernetes.io/force-ssl-redirect: "true"
        nginx.ingress.kubernetes.io/auth-type: basic
        nginx.ingress.kubernetes.io/auth-secret: ops-basic-auth
        nginx.ingress.kubernetes.io/auth-realm: 'Authentication Required'
      hosts:
        - 'grafana.${hostname}'
      tls:
        - secretName: grafana-general-tls
          hosts:
            - 'grafana.${hostname}'
  kubeScheduler:
    enabled: false
  kubeControllerManager:
    enabled: false
  prometheus:
    prometheusSpec:
      retention: 90d
      storageSpec:
        volumeClaimTemplate:
          spec:
            accessModes: [ "ReadWriteOnce" ]
            resources:
              requests:
                storage: 50Gi

ingress-nginx:
  defaultBackend:
    enabled: true
    image:
      image: ingress-nginx/nginx-errors
      tag: v20230312-helm-chart-4.5.2-28-g66a760794@sha256:332be6ff8c4e93e8845963932f98839dfd52ae49829c29e06475368a3e4fbd9e
    extraVolumes:
      - name: custom-error-pages
        configMap:
          name: custom-error-pages
          items:
            - key: "503.html"
              path: "5xx.html"
            - key: "503.json"
              path: "5xx.json"
    extraVolumeMounts:
      - name: custom-error-pages
        mountPath: /www
  controller:
    kind: "DaemonSet"
    admissionWebhooks:
      enabled: false
    hostPort:
      enabled: false
    ingressClass: "nginx"
    service:
      type: "NodePort"
      nodePorts:
        http: "32010"
        https: "32005"
    config:
      use-proxy-protocol: "true"
      keep-alive: "65"                 # Keep-alive timeout in seconds
      ssl-session-cache-size: "10m"      # SSL session cache size
      ssl-session-timeout: "1d"          # SSL session timeout
      upstream-keepalive-connections: "32"      # Number of keepalive connections per worker
      upstream-keepalive-timeout: "75"        # Timeout in seconds for keepalive connections
      upstream-keepalive-requests: "100"
      worker-processes: "auto"
      custom-http-errors: "503"

redis:
  architecture: "standalone"
  tls:
    authClients: false
  auth:
    enabled: false

mongodb:
  auth:
    enabled: false

rustici:
  password: '${rustici_password}'
  managedPassword: '${rustici_managed_password}'

# Memcached configuration
memcached:
  # Memcached server host - can be local service or remote ElastiCache cluster
  host: "${memcached_host}"
  # This enabled flag is for the local installation of memcache so true = install memcache on cluster (onprem)
  enabled: false

  # Use a specific image if needed for air-gapped
  image:
    registry: docker.io
    repository: bitnami/memcached
    tag: 1.6.21-debian-11-r0
    pullPolicy: IfNotPresent

  # Minimal single node configuration
  replicaCount: 1

  # Architecture: standalone for single node
  architecture: standalone

  # Minimal resource allocation
  resources:
    limits:
      memory: 64Mi
      cpu: 50m
    requests:
      memory: 32Mi
      cpu: 25m

  # Service configuration
  service:
    type: ClusterIP
    port: 11211

  # Disable persistence for minimal setup
  persistence:
    enabled: false

  # Minimal memory allocation for cache (in MB)
  memcachedMaxMemory: 32

  # Connection limit
  memcachedConnLimit: 1024

  # Disable metrics for minimal setup
  metrics:
    enabled: false

  # Security - disable SASL for simplicity
  auth:
    enabled: false

# OpenSearch configuration
opensearch:
  enabled: true

  # Single node configuration (set to false for production cluster)
  singleNode: true

  # Node group name
  nodeGroup: "master"

  # Number of master-eligible nodes (set to 3+ for HA production)
  masterReplicas: 1

  # Image configuration
  image:
    repository: "opensearchproject/opensearch"
    tag: "2.18.0"
    pullPolicy: "IfNotPresent"

  # Security disabled for dev - no auth required
  security:
    enabled: false

  # OpenSearch configuration - security plugin disabled for dev
  config:
    opensearch.yml: |
      network.host: 0.0.0.0
      plugins.security.disabled: true

  # Resource allocation
  resources:
    requests:
      cpu: "1000m"
      memory: "1Gi"
    limits:
      cpu: "1500m"
      memory: "2Gi"

  # Persistence configuration
  persistence:
    enabled: true
    size: 10Gi
    storageClass: ""  # Leave empty for default StorageClass

  # Service configuration
  service:
    type: ClusterIP
    port: 9200

  # Environment variables
  extraEnvs:
    - name: DISABLE_INSTALL_DEMO_CONFIG
      value: "true"
    - name: DISABLE_SECURITY_PLUGIN
      value: "true"

  # JVM heap size (should be ~50% of resources.requests.memory)
  opensearchJavaOpts: "-Xms512m -Xmx512m"

  # Pod disruption budget
  podDisruptionBudget:
    enabled: false
    minAvailable: 1

  # Ingress configuration (if exposing externally)
  ingress:
    enabled: false
#    ingressClassName: nginx
#    annotations:
#      nginx.ingress.kubernetes.io/ssl-redirect: "false"
#      nginx.ingress.kubernetes.io/backend-protocol: "HTTP"
#    hosts:
#      - opensearch.onprem.dozuki
#    tls: []

  # Secret for credentials (optional - use instead of inline passwords)
  # secretMounts:
  #   - name: opensearch-credentials
  #     secretName: opensearch-admin-credentials
  #     path: /usr/share/opensearch/config/opensearch-security